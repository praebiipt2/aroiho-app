
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")

}

// ============================================
// USERS
// ============================================
model User {
  id            String   @id @default(uuid()) @db.Uuid
  phone         String?  @unique @db.VarChar(20)
  email         String?  @unique @db.VarChar(255)
  passwordHash  String?  @map("password_hash") @db.VarChar(255)
  displayName   String?  @map("display_name") @db.VarChar(120)
  role          String   @default("CUSTOMER") @db.VarChar(30)
  status        String   @default("ACTIVE") @db.VarChar(20)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  addresses     Address[]
  carts         Cart[]
  orders        Order[]

  @@map("users")
}

// ============================================
// ADDRESSES
// ============================================
model Address {
  id            String   @id @default(uuid()) @db.Uuid
  userId        String   @map("user_id") @db.Uuid
  label         String?  @db.VarChar(50)
  receiverName  String   @map("receiver_name") @db.VarChar(120)
  phone         String   @db.VarChar(20)
  addressLine1  String   @map("address_line1") @db.Text
  addressLine2  String?  @map("address_line2") @db.Text
  province      String   @db.VarChar(100)
  district      String   @db.VarChar(100)
  subdistrict   String   @db.VarChar(100)
  postcode      String   @db.VarChar(10)
  lat           Decimal? @db.Decimal(10,7)
  lng           Decimal? @db.Decimal(10,7)
  isDefault     Boolean  @default(false) @map("is_default")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders        Order[]

  @@map("addresses")
}

// ============================================
// CATEGORIES
// ============================================
model Category {
  id          String    @id @default(uuid()) @db.Uuid
  parentId    String?   @map("parent_id") @db.Uuid
  name        String    @db.VarChar(100)
  slug        String    @unique @db.VarChar(120)
  iconUrl     String?   @map("icon_url") @db.Text
  bannerUrl   String?   @map("banner_url") @db.Text
  sortOrder   Int       @default(0) @map("sort_order")
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  parent      Category?  @relation("CategoryParent", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryParent")
  products    Product[]

  @@map("categories")
}

// ============================================
// SELLERS
// ============================================
model Seller {
  id          String   @id @default(uuid()) @db.Uuid
  type        String   @db.VarChar(20)
  name        String   @db.VarChar(200)
  taxId       String?  @map("tax_id") @db.VarChar(30)
  phone       String?  @db.VarChar(20)
  addressText String?  @map("address_text") @db.Text
  lat         Decimal? @db.Decimal(10,7)
  lng         Decimal? @db.Decimal(10,7)
  status      String   @default("ACTIVE") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  products        Product[]
  inventoryLots   InventoryLot[]
  certifications  SellerCertification[]
  orderItems      OrderItem[]

  @@map("sellers")
}

// ============================================
// CERTIFICATIONS
// ============================================
model Certification {
  id          String   @id @default(uuid()) @db.Uuid
  code        String   @unique @db.VarChar(30)
  name        String   @db.VarChar(200)
  issuer      String   @default("ARO IHO") @db.VarChar(200)
  description String?  @db.Text
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  sellers SellerCertification[]

  @@map("certifications")
}

model SellerCertification {
  id              String        @id @default(uuid()) @db.Uuid
  sellerId        String        @map("seller_id") @db.Uuid
  certificationId String        @map("certification_id") @db.Uuid
  validFrom       DateTime      @map("valid_from") @db.Date
  validTo         DateTime?     @map("valid_to") @db.Date
  evidenceUrl     String?       @map("evidence_url") @db.Text
  createdAt       DateTime      @default(now()) @map("created_at") @db.Timestamptz(6)

  seller        Seller        @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  certification Certification @relation(fields: [certificationId], references: [id])

  @@unique([sellerId, certificationId])
  @@map("seller_certifications")
}

// ============================================
// PRODUCTS
// ============================================
model Product {
  id            String   @id @default(uuid()) @db.Uuid
  sellerId      String   @map("seller_id") @db.Uuid
  categoryId    String   @map("category_id") @db.Uuid
  name          String   @db.VarChar(200)
  slug          String   @unique @db.VarChar(250)
  description   String?  @db.Text
  unit          String   @db.VarChar(50)
  basePrice     Decimal  @map("base_price") @db.Decimal(12,2)
  isActive      Boolean  @default(true) @map("is_active")
  thumbnailUrl  String?  @map("thumbnail_url") @db.Text
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  seller        Seller   @relation(fields: [sellerId], references: [id])
  category      Category @relation(fields: [categoryId], references: [id])
  images        ProductImage[]
  tags          ProductTag[]
  inventoryLots InventoryLot[]
  cartItems     CartItem[]
  orderItems    OrderItem[]

  @@map("products")
}

model ProductImage {
  id        String  @id @default(uuid()) @db.Uuid
  productId String  @map("product_id") @db.Uuid
  imageUrl  String  @map("image_url") @db.Text
  sortOrder Int     @default(0) @map("sort_order")

  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@map("product_images")
}

// ============================================
// TAGS
// ============================================
model Tag {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @db.VarChar(60)
  slug      String   @unique @db.VarChar(80)
  type      String   @default("FILTER") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  products ProductTag[]

  @@map("tags")
}

model ProductTag {
  id        String   @id @default(uuid()) @db.Uuid
  productId String   @map("product_id") @db.Uuid
  tagId     String   @map("tag_id") @db.Uuid

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([productId, tagId])
  @@map("product_tags")
}

// ============================================
// INVENTORY LOTS ⭐⭐⭐
// ============================================
model InventoryLot {
  id                       String    @id @default(uuid()) @db.Uuid
  productId                String    @map("product_id") @db.Uuid
  sellerId                 String    @map("seller_id") @db.Uuid
  lotCode                  String    @unique @map("lot_code") @db.VarChar(80)
  harvestedAt              DateTime? @map("harvested_at") @db.Date
  producedAt               DateTime? @map("produced_at") @db.Date
  packedAt                 DateTime? @map("packed_at") @db.Date
  expiresAt                DateTime? @map("expires_at") @db.Date
  shelfLifeDays            Int?      @map("shelf_life_days")
  recommendedConsumeBefore DateTime? @map("recommended_consume_before") @db.Date
  storageCondition         String?   @map("storage_condition") @db.Text
  quantityAvailable        Decimal   @map("quantity_available") @db.Decimal(12,3)
  status                   String    @default("ACTIVE") @db.VarChar(20)
  createdAt                DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  product   Product     @relation(fields: [productId], references: [id])
  seller    Seller      @relation(fields: [sellerId], references: [id])
  cartItems CartItem[]
  orderItems OrderItem[]

  @@index([productId])
  @@index([sellerId])
  @@map("inventory_lots")
}

// ============================================
// CART
// ============================================
model Cart {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  status    String   @default("ACTIVE") @db.VarChar(20)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  items CartItem[]

  @@map("carts")
  @@index([userId, status])
}

model CartItem {
  id             String   @id @default(uuid()) @db.Uuid
  cartId         String   @map("cart_id") @db.Uuid
  productId      String   @map("product_id") @db.Uuid
  inventoryLotId String   @map("inventory_lot_id") @db.Uuid
  quantity       Decimal  @db.Decimal(12,3)
  unitPrice      Decimal  @map("unit_price") @db.Decimal(12,2)

  cart         Cart         @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id])
  inventoryLot InventoryLot @relation(fields: [inventoryLotId], references: [id])

  @@map("cart_items")
  @@unique([cartId, inventoryLotId])
  @@index([cartId])
}

// ============================================
// ORDERS
// ============================================
model Order {
  id            String   @id @default(uuid()) @db.Uuid
  orderNo       String   @unique @map("order_no") @db.VarChar(30)
  userId        String   @map("user_id") @db.Uuid
  addressId     String   @map("address_id") @db.Uuid
  paymentStatus String   @default("PENDING") @map("payment_status") @db.VarChar(20)
  orderStatus   String   @default("CONFIRMED") @map("order_status") @db.VarChar(30)
  subtotal      Decimal  @db.Decimal(12,2)
  deliveryFee   Decimal  @map("delivery_fee") @db.Decimal(12,2)
  discount      Decimal  @default(0) @db.Decimal(12,2)
  total         Decimal  @db.Decimal(12,2)
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  user     User        @relation(fields: [userId], references: [id])
  address  Address     @relation(fields: [addressId], references: [id])
  items    OrderItem[]
  payments Payment[]

  @@map("orders")
}

model OrderItem {
  id             String  @id @default(uuid()) @db.Uuid
  orderId        String  @map("order_id") @db.Uuid
  productId      String  @map("product_id") @db.Uuid
  inventoryLotId String  @map("inventory_lot_id") @db.Uuid
  sellerId       String  @map("seller_id") @db.Uuid
  quantity       Decimal @db.Decimal(12,3)
  unitPrice      Decimal @map("unit_price") @db.Decimal(12,2)
  lineTotal      Decimal @map("line_total") @db.Decimal(12,2)

  order        Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product      Product      @relation(fields: [productId], references: [id])
  inventoryLot InventoryLot @relation(fields: [inventoryLotId], references: [id])
  seller       Seller       @relation(fields: [sellerId], references: [id])

  @@map("order_items")
}

model Payment {
  id          String    @id @default(uuid()) @db.Uuid
  orderId     String    @map("order_id") @db.Uuid
  provider    String    @db.VarChar(50)
  providerRef String?   @map("provider_ref") @db.VarChar(120)
  amount      Decimal   @db.Decimal(12,2)
  status      String    @default("PENDING") @db.VarChar(20)
  paidAt      DateTime? @map("paid_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  order Order @relation(fields: [orderId], references: [id])

  @@map("payments")
}